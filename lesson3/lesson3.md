В данном уроке мы разбираемся с обновленной структурой базы данных, а также разбираем новые функции для решения дальнейших задач

Основные сущности и связи в базе данных:

1.**Крепость (Fortresses)**: Основная сущность, связанная с гномами (1:n), мастерскими (1:n), военными отрядами (1:n), ресурсами (n:m)

2.**Гномы (Dwarves)**: Принадлежат крепости (n:1), связаны с навыками (n:m), назначениями (1:n), снаряжением (n:m), интересами (1:n)

3.**Навыки (Skills)**: Категории умений, связанные с гномами через dwarf_skills (n:m)

4.**Назначения гномов (Dwarf_Assignments)**: Привязаны к гному (n:1), содержат информацию о рабочих задачах

5.**Снаряжение гномов (Dwarf_Equipment)**: Связывает гномов с их личным снаряжением (n:m)

6.**Мастерские (Workshops)**: Принадлежат крепости (n:1), включают ремесленников (n:m), материалы (n:m), производят продукты (1:n)

7.**Ремесленники мастерских (Workshop_Craftsdwarves)**: Связывает мастерские и гномов (n:m)

8.**Материалы мастерских (Workshop_Materials)**: Связывает мастерские с используемыми материалами (n:m)

9.**Продукты мастерских (Workshop_Products)**: Связывает мастерские с производимыми продуктами (n:m)

10.**Продукты (Products)**: Результаты производства, связаны с материалами (n:1), мастерскими (n:1)

11.**Военные отряды (Military_Squads)**: Относятся к крепости (n:1), имеют лидера (n:1), членов (1:n), снаряжение (n:m)

12.**Члены отрядов (Squad_Members)**: Связывает гномов с отрядами (n:m), содержит историю членства

13.**Операции отрядов (Squad_Operations)**: Проводятся отрядами (n:1), содержат информацию о военных операциях

14.**Тренировки отрядов (Squad_Training)**: Связаны с отрядами (n:1), содержат данные о тренировках

15.**Сражения отрядов (Squad_Battles)**: Связаны с отрядами (n:1), содержат информацию о сражениях

16.**Участие в битвах (Squad_Battle_Participation)**: Связывает отряды с атаками существ (n:m)

17.**Снаряжение отрядов (Squad_Equipment)**: Связывает отряды со снаряжением (n:m)

18.**Снаряжение (Equipment)**: Используется гномами (n:m) и отрядами (n:m), изготавливается из материалов (n:1)

19.**Ресурсы (Resources)**: Добываются, используются в производстве, хранятся

20.**Места добычи (Extraction_Sites)**: Связаны с ресурсами (n:1), содержат информацию о местах добычи

21.**Ресурсы крепости (Fortress_Resources)**: Связывает крепости с доступными ресурсами (n:m)

22.**Содержимое складов (Stockpile_Contents)**: Связывает склады с хранимыми ресурсами (n:m)

23.**Проекты (Projects)**: Выполняются в мастерских (n:1), включают работников (n:m), материалы (n:m)

24.**Работники проектов (Project_Workers)**: Связывает проекты с назначенными гномами (n:m)

25.**Материалы проектов (Project_Materials)**: Связывает проекты с необходимыми материалами (n:m)

26.**Зависимости проектов (Project_Dependencies)**: Определяет зависимости между проектами (n:m)

27.**Зоны проектов (Project_Zones)**: Связывает проекты с зонами крепости (n:m)

28.**Приказы (Orders)**: Связаны с проектами (n:1), содержат информацию о задачах

29.**Караваны (Caravans)**: Посещают крепость, включают торговцев (1:n), товары (1:n), участвуют в транзакциях (1:n)

30.**Торговцы (Traders)**: Принадлежат караванам (n:1), специализируются на определенных товарах

31.**Товары караванов (Caravan_Goods)**: Связаны с караванами (n:1), представляют доступные товары. type отвечает за экспорт/импорт.

32.**Торговые транзакции (Trade_Transactions)**: Связаны с караванами (n:1), фиксируют обмен товарами (через value)

33.**Интересы гномов (Dwarf_Interests)**: Связаны с гномами (n:1), определяют предпочтения в товарах

34.**Дипломатические события (Diplomatic_Events)**: Связаны с караванами (n:1), фиксируют отношения с цивилизациями

35.**Существа (Creatures)**: Имеют тип, уровень угрозы, связаны с наблюдениями (1:n), атаками (1:n), территориями (1:n)

36.**Наблюдения существ (Creature_Sightings)**: Фиксируют обнаружение существ (n:1)

37.**Атаки существ (Creature_Attacks)**: Связаны с существами (n:1), локациями (n:1), структурами защиты (n:m)

38.**Территории существ (Creature_Territories)**: Связаны с существами (n:1), определяют ареал обитания

39.**Экспедиции (Expeditions)**: Включают участников (1:n), посещают места (1:n), обнаруживают артефакты (1:n)

40.**Участники экспедиций (Expedition_Members)**: Связывают экспедиции с гномами (n:m)

41.**Места экспедиций (Expedition_Sites)**: Связывают экспедиции с посещенными местами (n:m)

42.**Встречи с существами (Expedition_Creatures)**: Связывают экспедиции с встреченными существами (n:m)

43.**Снаряжение экспедиций (Expedition_Equipment)**: Связывает экспедиции со снаряжением (n:m)

44.**Артефакты экспедиций (Expedition_Artifacts)**: Связаны с экспедициями (n:1), содержат данные о находках

45.**Отчеты экспедиций (Expedition_Reports)**: Связаны с экспедициями (n:1), содержат информацию о результатах

46.**Локации (Locations)**: Определяют места в крепости, содержат информацию о защищенности и доступности

47.**Структуры защиты (Defense_Structures)**: Размещены в локациях (n:1), используются при обороне

48.**Военные станции (Military_Stations)**: Связаны с отрядами (n:1), локациями (n:1), определяют размещение отрядов

49.**Передвижения отрядов (Squad_Movement)**: Связывают отряды с патрулируемыми зонами (n:m)

50.**Зоны военного покрытия (Military_Coverage_Zones)**: Связывают отряды с зонами и временем реакции (n:m)

51.**События крепости (Fortress_Events)**: Фиксируют важные события, влияющие на крепость

52.**Записи о погоде (Weather_Records)**: Содержат данные о погодных условиях в разные даты

53.**Фазы луны (Moon_Phases)**: Фиксируют фазы луны, влияющие на игровые механики

54.**Рекомендации по безопасности (Security_Recommendations)**: Содержат рекомендации по улучшению защиты крепости

Новые функции:

JSON_OBJECT - данная функция принимает пары значений, которые преобразуются в объект JSON, где каждый элемент - пара - ключ (первый объект пары) и значение (второй объект пары)

JSON_ARRAYAGG - данная функция агрегирует входные данные и преобразует их в массив, причем, что тип данных должен быть один и тот же у элементов массива.

Задача 1. Напишите SQL запрос, который возвращает данные о крепости, включая список идентификаторов всех проживающих гномов, доступных ресурсов, построенных мастерских и военных отрядов.

```sql
SELECT 
    F.name AS FortressName,
    F.location AS FortressLocation,
    F.founded_year AS FortressFoundedYear,
    F.depth AS FortressDepth,
    F.population AS FortressPopulation,
    JSON_OBJECT(
        ('dwarves_ids', (
            SELECT JSON_ARRAYGG(D.dwarf_id) FROM Dwarves D
            WHERE D.fortress_id = F.fortress_id
        )),
        ('resources_ids', (
            SELECT JSON_ARRAYGG(FR.resource_id) FROM Fortress_Resources FR
            WHERE FR.fortress_id = F.fortress_id
        )),
        ('workshops_ids', (
            SELECT JSON_ARRAYGG(W.workshop_id) FROM Workshops W
            WHERE W.fortress_id = F.fortress_id
        )),
        ('military_squads_ids', (
            SELECT JSON_ARRAYGG(MS.squad_id) FROM Military_Squads MS
            WHERE MS.fortress_id = F.fortress_id
        ))
    ) as fortress_info
FROM 
    Fortresses F;
```